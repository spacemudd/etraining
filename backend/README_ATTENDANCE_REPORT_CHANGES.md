# تحديثات نظام تقارير الحضور والانصراف للشركات

## ملخص التغييرات

تم تحديث نظام تقارير الحضور والانصراف للشركات ليشمل:

1. **المتدربين النشطين** (غير المحذوفين)
2. **المتدربين الذين لهم استقالة ومحذوف معاً** (فقط) - حتى تاريخ الاستقالة

## الملفات المعدلة

### 1. `app/Http/Controllers/Back/CompanyAttendanceReportController.php`
- **الدالة**: `store()`
- **التغيير**: تم تعديل منطق إنشاء التقرير ليشمل المتدربين النشطين والمتدربين المستقيلين المحذوفين فقط

### 2. `app/Services/CompanyAttendanceReportService.php`
- **الدوال**: `newReport()`, `clone()`, `makePdf()`, `makeIndividualPdf()`
- **التغيير**: تم تحديث جميع الدوال لتشمل المتدربين النشطين والمتدربين المستقيلين المحذوفين فقط

### 3. `app/Models/Back/CompanyAttendanceReport.php`
- **الدالة الجديدة**: `getAllTraineesWithResignations()`
- **الوظيفة**: تجميع المتدربين النشطين والمتدربين المستقيلين المحذوفين فقط

### 4. `app/Models/Back/Resignation.php`
- **التغيير**: إضافة `resignation_date` إلى `$dates` array

### 5. `app/Exports/CompanyAttendanceSheetExport.php`
- **الدالة**: `view()`
- **التغيير**: تحديث منطق استخراج البيانات ليشمل المتدربين النشطين والمتدربين المستقيلين المحذوفين فقط

### 6. `resources/views/exports/company-attendance-sheet.blade.php`
- **التغيير**: إضافة أعمدة جديدة لعرض:
  - حالة المتدرب (نشط، محذوف، مستقيل ومحذوف)
  - تاريخ الاستقالة

### 7. `database/migrations/2025_05_12_082224_add_resignation_date_to_resignations_table.php`
- **التغيير**: إصلاح دالة `down()` لإزالة العمود بشكل صحيح

## المنطق الجديد

### عند إنشاء تقرير الحضور والانصراف:

1. **المتدربين النشطين**: يتم تضمينهم كما هو معتاد
2. **المتدربين المستقيلين المحذوفين**: يتم تضمينهم **فقط** إذا كان لديهم:
   - استقالة بحالة `'new'` أو `'sent'` (جديدة أو تم إرسالها)
   - تاريخ استقالة في نفس فترة التقرير أو بعده
   - محذوفين بـ soft delete

### معايير الاستقالة:

- **الحالة**: يجب أن تكون `'new'` أو `'sent'` (جديدة أو تم إرسالها)
- **التاريخ**: يجب أن يكون `resignation_date >= date_from`
- **الشركة**: يجب أن تكون نفس شركة التقرير
- **الحالة**: يجب أن يكون المتدرب محذوف بـ soft delete

## النتائج المتوقعة

بعد هذه التحديثات، سيتضمن شيت الحضور والانصراف:

- ✅ المتدربين النشطين
- ✅ المتدربين المستقيلين المحذوفين (فقط) - حتى تاريخ الاستقالة
- ❌ المتدربين المحذوفين بدون استقالة (لن يظهروا)
- ❌ المتدربين المستقيلين غير المحذوفين (لن يظهروا)
- ✅ معلومات إضافية عن حالة كل متدرب
- ✅ تاريخ الاستقالة للمتدربين المستقيلين المحذوفين

## ملاحظات مهمة

1. **الشرط المزدوج**: يتم تضمين المتدرب فقط إذا كان له استقالة **ومحذوف معاً**
2. **عدم تكرار البيانات**: يتم إزالة التكرارات بناءً على ID المتدرب
3. **الأداء**: تم تحسين الاستعلامات لتجنب تكرار البيانات
4. **التوافق**: جميع التغييرات متوافقة مع النظام الحالي
5. **PDF**: تم تحديث ملفات PDF لتشمل المعلومات الجديدة

## اختبار التغييرات

لتأكيد عمل التغييرات:

1. إنشاء تقرير حضور وانصراف جديد
2. التأكد من ظهور المتدربين النشطين
3. التأكد من ظهور المتدربين المستقيلين المحذوفين فقط
4. التأكد من عدم ظهور المتدربين المحذوفين بدون استقالة
5. التأكد من صحة تاريخ الاستقالة
6. اختبار تصدير Excel و PDF 