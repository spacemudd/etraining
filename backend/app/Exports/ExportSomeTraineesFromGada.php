<?php

namespace App\Exports;

use App\Models\Back\Trainee;
use App\Models\Back\Company;
use Maatwebsite\Excel\Concerns\FromCollection;
use Maatwebsite\Excel\Concerns\WithHeadings;
use Carbon\Carbon;

class ExportSomeTraineesFromGada implements FromCollection, WithHeadings
{
    protected $maxCertificatesCount = 0;

    public function collection()
    {
        $Ids = [
            '1086743802',
            '1032728972',
            '1117021228',
            '1128689039',
            '1003497573',
            '1068874609',
            '1110080361',
            '1080709403',
            '1119705984',
            '1098389750',
            '1046156996',
            '1073350470',
            '1104865512',
            '1085492906',
            '1099709014',
            '1056951633',
            '1136461991',
            '1084223443',
            '1073994459',
            '1085042628',
            '1108423813',
            '1122295627',
            '1117321602',
            '1115597534',
            '1116004217',
            '1075330033',
            '1125076958',
            '1115086199',
            '1123851550',
            '1068874146',
            '1030531600',
            '1113953655',
            '1083169746',
            '1086605100',
            '1090389600',
            '1136693221',
            '1086835905',
            '1097143331',
            '1093616868',
            '1069541959',
            '1133266575',
            '1135753398',
            '1079117246',
            '1043957578',
            '1076275989',
            '1105347031',
            '1111594030',
            '1148036286',
            '1073307207',
            '1079233647',
            '1126382157',
            '1088781743',
            '1109852853',
            '1076942364',
            '1102864087',
            '1089005282',
            '1093323952',
            '1124882703',
            '1078148499',
            '1100373651',
            '1128623095',
            '1109614428',
            '1101160271',
            '1075109247',
            '1110984570',
            '1074958461',
            '1012416655',
            '1092951779',
            '1088308331',
            '1024073973',
            '1104058340',
            '1067978153',
            '1073805598',
            '1063079956',
            '1050741592',
            '1078276118',
            '1070087158',
            '1030846818',
            '1134063922',
            '1111852867',
            '1051985941',
            '1106540030',
            '1111377766',
            '1127524385',
            '1062200496',
            '1111565196',
            '1015038258',
            '1084981974',
            '1066638816',
            '1099238030',
            '1103853691',
            '1118840550',
            '1113719734',
            '1094432471',
            '1039576077',
            '1013239460',
            '1078248356',
            '1085866141',
            '1071802779',
            '1022461410',
            '1081409854',
            '1084555612',
            '1101854899',
            '1063060311',
            '1118009842',
            '1033952829',
            '1093396206',
            '1121726804',
            '1101289112',
            '1095511547',
            '1084419330',
            '1093585873',
            '1110693114',
            '1100223914',
            '1078322334',
            '1098899998',
            '1102304852',
            '1111546485',
            '1100466703',
            '1105786444',
            '1077890760',
            '1082051275',
            '1077208658',
            '1140705516',
            '1098704610',
            '1084763414',
            '1130294109',
            '1105078990',
            '1068616331',
            '1120195498',
            '1095185672',
            '1080429861',
            '1121641722',
            '1112454234',
            '1128824446',
            '1093991576',
            '1092559747',
            '1031242025',
            '1087276828',
            '1142778560',
            '1080243643',
            '1085859369',
            '1087953590',
            '1121562993',
            '1088687593',
            '1086650973',
            '1076297512',
            '1048560799',
            '1096737661',
            '1114128562',
            '1050193919',
            '1099269290',
            '1078238407',
            '1207388487',
            '1099059949',
            '1090021104',
            '1062128846',
            '1087788152',
            '1108499656',
            '1031242017',
            '1104678071',
            '1100136256',
            '1037051495',
            '1091674588',
            '1109030260',
            '1057342311',
            '1087554877',
            '1106987488',
            '1093061321',
            '1097791246',
            '1125392488',
            '1116835149',
            '1079779284',
            '1116735380',
            '1035011244',
            '1109301554',
            '1073027748',
            '1074352111',
            '1092605243',
            '1109182574',
            '1093902425',
            '1095473649',
            '1098100652',
            '1049924184',
            '1102618343',
            '1116172824',
            '1105539579',
            '1095637284',
            '1092559911',
            '1105702615',
            '1103555775',
            '1096543432',
            '1057267005',
            '1106125808',
            '1094398946',
            '1127014072',
            '1089202236',
            '1110731575',
            '1098748716',
            '1123225706',
            '1102849914',
            '1075191385',
            '1083366946',
            '1059187417',
            '1088867021',
            '1072221888',
            '1113953929',
            '1079820138',
            '1050623345',
            '1068625142',
            '1108428366',
            '1085644373',
            '1101597571',
            '1073739532',
            '1075359511',
            '1097737017',
            '1114441858',
            '1082306232',
            '1118484656',
            '1111035216',
            '1098782558',
            '1117430460',
            '1104722119',
            '1102029111',
            '1070826746',
            '1126229614',
            '1098219775',
            '1028746368',
            '1118073418',
            '1047881923',
            '1081685420',
            '1095640940',
            '1083368983',
            '1065051797',
            '1079332472',
            '1102190426',
            '1092383429',
        ];

        // جلب المتدربين بناءً على identity_number مع الشهادات
        $trainees = Trainee::withTrashed()
            ->whereIn('identity_number', $Ids)
            ->with([
                'custom_certificates' => function($q) {
                    $q->orderBy('created_at', 'desc');
                },
                'uk_certificates' => function($q) {
                    $q->where('status', 'sent')
                      ->with(['ukCertificate.course'])
                      ->orderBy('sent_at', 'desc');
                }
            ])
            ->get();

        // حساب الحد الأقصى لعدد الشهادات
        $this->maxCertificatesCount = 0;
        foreach ($trainees as $trainee) {
            $count = $trainee->custom_certificates->count() + $trainee->uk_certificates->count();
            $this->maxCertificatesCount = max($this->maxCertificatesCount, $count);
        }

        return $trainees->map(function ($trainee) {
            $certificates = [];
            
            // جمع الشهادات المخصصة
            foreach ($trainee->custom_certificates as $cert) {
                $certificates[] = $cert->title;
            }
            
            // جمع شهادات UK
            foreach ($trainee->uk_certificates as $cert) {
                if ($cert->ukCertificate && $cert->ukCertificate->course) {
                    $certificates[] = $cert->ukCertificate->course->name_ar ?? 'غير محدد';
                }
            }
            
            $certificatesCount = count($certificates);
            
            // إنشاء الصف
            $row = [
                'identity_number' => $trainee->identity_number,
                'name' => $trainee->name,
                'certificates_count' => $certificatesCount,
            ];
            
            // إضافة أسماء الشهادات كأعمدة
            for ($i = 0; $i < $this->maxCertificatesCount; $i++) {
                $row['certificate_' . $i] = $certificates[$i] ?? '';
            }
            
            return $row;
        });
    }

    protected function calculateMaxCertificatesCount()
    {
        if ($this->maxCertificatesCount > 0) {
            return $this->maxCertificatesCount;
        }

        $Ids = [
            '1086743802', '1032728972', '1117021228', '1128689039', '1003497573',
            '1068874609', '1110080361', '1080709403', '1119705984', '1098389750',
            '1046156996', '1073350470', '1104865512', '1085492906', '1099709014',
            '1056951633', '1136461991', '1084223443', '1073994459', '1085042628',
            '1108423813', '1122295627', '1117321602', '1115597534', '1116004217',
            '1075330033', '1125076958', '1115086199', '1123851550', '1068874146',
            '1030531600', '1113953655', '1083169746', '1086605100', '1090389600',
            '1136693221', '1086835905', '1097143331', '1093616868', '1069541959',
            '1133266575', '1135753398', '1079117246', '1043957578', '1076275989',
            '1105347031', '1111594030', '1148036286', '1073307207', '1079233647',
            '1126382157', '1088781743', '1109852853', '1076942364', '1102864087',
            '1089005282', '1093323952', '1124882703', '1078148499', '1100373651',
            '1128623095', '1109614428', '1101160271', '1075109247', '1110984570',
            '1074958461', '1012416655', '1092951779', '1088308331', '1024073973',
            '1104058340', '1067978153', '1073805598', '1063079956', '1050741592',
            '1078276118', '1070087158', '1030846818', '1134063922', '1111852867',
            '1051985941', '1106540030', '1111377766', '1127524385', '1062200496',
            '1111565196', '1015038258', '1084981974', '1066638816', '1099238030',
            '1103853691', '1118840550', '1113719734', '1094432471', '1039576077',
            '1013239460', '1078248356', '1085866141', '1071802779', '1022461410',
            '1081409854', '1084555612', '1101854899', '1063060311', '1118009842',
            '1033952829', '1093396206', '1121726804', '1101289112', '1095511547',
            '1084419330', '1093585873', '1110693114', '1100223914', '1078322334',
            '1098899998', '1102304852', '1111546485', '1100466703', '1105786444',
            '1077890760', '1082051275', '1077208658', '1140705516', '1098704610',
            '1084763414', '1130294109', '1105078990', '1068616331', '1120195498',
            '1095185672', '1080429861', '1121641722', '1112454234', '1128824446',
            '1093991576', '1092559747', '1031242025', '1087276828', '1142778560',
            '1080243643', '1085859369', '1087953590', '1121562993', '1088687593',
            '1086650973', '1076297512', '1048560799', '1096737661', '1114128562',
            '1050193919', '1099269290', '1078238407', '1207388487', '1099059949',
            '1090021104', '1062128846', '1087788152', '1108499656', '1031242017',
            '1104678071', '1100136256', '1037051495', '1091674588', '1109030260',
            '1057342311', '1087554877', '1106987488', '1093061321', '1097791246',
            '1125392488', '1116835149', '1079779284', '1116735380', '1035011244',
            '1109301554', '1073027748', '1074352111', '1092605243', '1109182574',
            '1093902425', '1095473649', '1098100652', '1049924184', '1102618343',
            '1116172824', '1105539579', '1095637284', '1092559911', '1105702615',
            '1103555775', '1096543432', '1057267005', '1106125808', '1094398946',
            '1127014072', '1089202236', '1110731575', '1098748716', '1123225706',
            '1102849914', '1075191385', '1083366946', '1059187417', '1088867021',
            '1072221888', '1113953929', '1079820138', '1050623345', '1068625142',
            '1108428366', '1085644373', '1101597571', '1073739532', '1075359511',
            '1097737017', '1114441858', '1082306232', '1118484656', '1111035216',
            '1098782558', '1117430460', '1104722119', '1102029111', '1070826746',
            '1126229614', '1098219775', '1028746368', '1118073418', '1047881923',
            '1081685420', '1095640940', '1083368983', '1065051797', '1079332472',
            '1102190426', '1092383429',
        ];

        $trainees = Trainee::withTrashed()
            ->whereIn('identity_number', $Ids)
            ->with([
                'custom_certificates',
                'uk_certificates' => function($q) {
                    $q->where('status', 'sent');
                }
            ])
            ->get();

        $maxCount = 0;
        foreach ($trainees as $trainee) {
            $count = $trainee->custom_certificates->count() + $trainee->uk_certificates->count();
            $maxCount = max($maxCount, $count);
        }

        $this->maxCertificatesCount = $maxCount;
        return $this->maxCertificatesCount;
    }

    public function headings(): array
    {
        // حساب الحد الأقصى إذا لم يكن محسوباً بعد
        $this->calculateMaxCertificatesCount();

        $headings = [
            'الهوية',
            'الإسم',
            'عدد الشهادات المستلمة',
        ];
        
        // إضافة عناوين الأعمدة للشهادات
        for ($i = 1; $i <= $this->maxCertificatesCount; $i++) {
            $headings[] = 'شهادة ' . $i;
        }
        
        return $headings;
    }
}
